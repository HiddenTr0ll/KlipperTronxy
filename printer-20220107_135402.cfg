# This is a Klipper configuration for Tron XY-2 Pro, with
# CXY-V6 motherboard.


#            === FLASHING WITH STOCK BOOTLOADER ===
# You should make firmware for STM32F103 with bootloader offset
# at 0x8008800 (Chitu v6 Bootloader). Uncheck USB, and leave default
# serial settings.
#
# Use "./scripts/update_chitu.py ./out/klipper.bin ./out/update.cbd" after make to generate update.cbd.
# Put `update.cbd` onto SD card, and reboot the printer.
# It will be automatically installed, and you will be able to update it this way.
[bltouch]
x_offset: 57
y_offset: 12.5
control_pin:PB11
sensor_pin:^PD12
pin_up_touch_mode_reports_triggered:False
z_offset: 1.84

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB2.0-Serial-if00-port0
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 150
max_accel: 3000
max_z_velocity: 5
max_z_accel: 100


[stepper_x]
step_pin: PE5
dir_pin: PE6
enable_pin: !PC13
microsteps: 16
rotation_distance: 20
endstop_pin: !PG10
position_endstop: 2
position_min: 2
position_max: 249
homing_speed: 50
homing_retract_dist: 10
second_homing_speed: 10.0

[stepper_y]
step_pin: PE2
dir_pin: PE3
enable_pin: !PE4
microsteps: 16
rotation_distance: 20
endstop_pin: !PA12
position_endstop: -11
position_min:-11
position_max: 250
homing_retract_dist: 10
homing_speed: 50.0
second_homing_speed: 10.0

[stepper_z]
step_pin: PB9
dir_pin: !PE0
enable_pin: !PE1
microsteps: 16
rotation_distance: 1
endstop_pin: probe:z_virtual_endstop
position_max: 260
position_min: -10

[extruder]
step_pin: PB4
dir_pin: PB5
enable_pin: !PB8
microsteps: 16
rotation_distance: 16.9024
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PG12
sensor_type: ATC Semitec 104GT-2
sensor_pin: PA1
control: pid
pid_Kp: 18.831
pid_Ki: 0.821
pid_Kd: 108.044
min_temp: 0
max_temp: 260
max_extrude_only_distance: 800
min_extrude_temp: 0
max_extrude_cross_section: 1.5

[heater_bed]
heater_pin: PG11
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA0
control: pid
min_temp: 0
max_temp: 130
pid_Kp: 73.932
pid_Ki: 1.521
pid_Kd: 898.279

[heater_fan hotend_fan]
pin: PG14
heater: extruder
shutdown_speed: 0
cycle_time: 0.010
#hardware_pwm: True
kick_start_time: 0.100
heater_temp: 50
fan_speed: 1.0

[fan]
pin: PG13
max_power: 1

[controller_fan drivers_fan]
pin: PD6

[filament_switch_sensor sentinel]
pause_on_runout: True
runout_gcode:
  M25
switch_pin: !PA15

[output_pin beeper]
pin: PB0

[safe_z_home]
home_xy_position: 127,127
speed: 150
z_hop: 20
z_hop_speed: 5

[bed_mesh]
speed: 70
probe_count: 25,25
horizontal_move_z: 5
algorithm: lagrange
mesh_min : 60,15
mesh_max : 240,220
mesh_pps: 0

[virtual_sdcard]
path: ~/gcode_files

[display_status]

[pause_resume]

[gcode_macro BL_DOWN]
gcode:
    BLTOUCH_DEBUG COMMAND=pin_down

[gcode_macro BL_UP]
gcode:
    BLTOUCH_DEBUG COMMAND=pin_up

[gcode_macro BL_TOUCHMODE]
gcode:
    BLTOUCH_DEBUG COMMAND=touch_mode

[gcode_macro BL_QUERY_PROBE]
gcode:
    QUERY_PROBE




[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    TURN_OFF_HEATERS
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    BASE_CANCEL_PRINT





[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
    ##### set defaults #####
    {% set x = params.X|default(230) %}      #edit to your park position
    {% set y = params.Y|default(230) %}      #edit to your park position
    {% set z = params.Z|default(10)|float %} #edit to your park position
    {% set e = params.E|default(1) %}        #edit to your retract length
    ##### calculate save lift position #####
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% set lift_z = z|abs %}
    {% if act_z < (max_z - lift_z) %}
        {% set z_safe = lift_z %}
    {% else %}
        {% set z_safe = max_z - act_z %}
    {% endif %}
    ##### end of definitions #####
    SAVE_GCODE_STATE NAME=PAUSE_state
    BASE_PAUSE
    G91
    G1 E-{e} F2100
    G1 Z{z_safe}
    G90
    G1 X{x} Y{y} F6000


[gcode_macro RESUME]
rename_existing: BASE_RESUME
gcode:
    ##### set defaults #####
    {% set e = params.E|default(1) %} #edit to your retract length
    G91
    G1 E{e} F2100
    G90
    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
    BASE_RESUME

[force_move]
enable_force_move: True

[gcode_macro UNLOCK_MOTORS]
gcode:
  SET_KINEMATIC_POSITION X=127 Y=127 Z=127

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.080625, 0.095937, 0.031562, 0.141562, 0.126250, 0.145937, 0.164062, 0.169687, 0.163125, 0.181875, 0.180312, 0.194687, 0.161562, 0.168125, 0.164687, 0.122812, 0.099687, 0.102812, 0.105000, 0.074687, 0.050625, 0.013750, -0.015313, -0.047188, -0.089688
#*# 	-0.006563, 0.008125, -0.052500, 0.041562, 0.045625, 0.063437, 0.074375, 0.070625, 0.070625, 0.063125, 0.083750, 0.080312, 0.055937, 0.064062, 0.052812, 0.011562, -0.005938, -0.004688, 0.007812, -0.024375, -0.030938, -0.075313, -0.101250, -0.134063, -0.190938
#*# 	0.033750, 0.048125, -0.007188, 0.083125, 0.079687, 0.107812, 0.120000, 0.118437, 0.100625, 0.112187, 0.120625, 0.126562, 0.109375, 0.116250, 0.116250, 0.086250, 0.046250, 0.053437, 0.059375, 0.052812, 0.035312, 0.013750, -0.010000, -0.047188, -0.075625
#*# 	-0.064688, -0.040938, -0.005938, 0.002500, -0.005938, 0.022187, 0.030000, 0.038437, 0.032187, 0.038437, 0.029062, 0.051875, 0.038125, 0.052812, 0.048437, 0.035937, 0.012500, 0.005937, 0.026875, 0.021875, 0.002500, -0.003438, -0.022813, -0.051250, -0.105000
#*# 	-0.111563, -0.099688, -0.067813, -0.063750, -0.066875, -0.058125, -0.045625, -0.041563, -0.040313, -0.020313, -0.039688, -0.024688, -0.043750, -0.023750, -0.028125, -0.050000, -0.081875, -0.071250, -0.055313, -0.071875, -0.063125, -0.080625, -0.108438, -0.126563, -0.151250
#*# 	-0.102500, -0.087188, -0.039375, -0.063125, -0.067188, -0.045313, -0.036563, -0.025938, -0.035313, -0.015313, -0.027813, -0.023125, -0.043125, -0.024688, -0.030000, -0.041875, -0.065000, -0.065625, -0.036563, -0.051250, -0.041875, -0.065313, -0.084375, -0.098750, -0.144063
#*# 	-0.039688, -0.028750, 0.004687, -0.013438, -0.007500, -0.011563, 0.001875, 0.010937, -0.004375, 0.013437, 0.006875, 0.014062, -0.006875, -0.001563, -0.003438, -0.024375, -0.048750, -0.045313, -0.027813, -0.048125, -0.041563, -0.056563, -0.071875, -0.099688, -0.116563
#*# 	0.076562, 0.086562, 0.114062, 0.109062, 0.095312, 0.110937, 0.117500, 0.115000, 0.110625, 0.117500, 0.108125, 0.113750, 0.089687, 0.091250, 0.091875, 0.067812, 0.032187, 0.032187, 0.069062, 0.052500, 0.049062, 0.051875, 0.017500, 0.007187, -0.032813
#*# 	0.153437, 0.161250, 0.178125, 0.171875, 0.162500, 0.163437, 0.172500, 0.172812, 0.179687, 0.168125, 0.158125, 0.151562, 0.127187, 0.138750, 0.150625, 0.116250, 0.072500, 0.085937, 0.093125, 0.077812, 0.078750, 0.073125, 0.061250, 0.036562, 0.024687
#*# 	0.164687, 0.170312, 0.200625, 0.191250, 0.190000, 0.187812, 0.200000, 0.195000, 0.182500, 0.188125, 0.173750, 0.171250, 0.146562, 0.157500, 0.145625, 0.126875, 0.093437, 0.094687, 0.127500, 0.108750, 0.098125, 0.096562, 0.082187, 0.068125, 0.044687
#*# 	0.155625, 0.162187, 0.188750, 0.166250, 0.161562, 0.167812, 0.181875, 0.171250, 0.177500, 0.168750, 0.168750, 0.168750, 0.136250, 0.131250, 0.141875, 0.092500, 0.060000, 0.066875, 0.083437, 0.101875, 0.075937, 0.080937, 0.062812, 0.067500, 0.034375
#*# 	0.115000, 0.110937, 0.134375, 0.125937, 0.120937, 0.120937, 0.130000, 0.125000, 0.127187, 0.122812, 0.115625, 0.131562, 0.107812, 0.110000, 0.108437, 0.095000, 0.046875, 0.065312, 0.092812, 0.080937, 0.083750, 0.085625, 0.084062, 0.087187, 0.047812
#*# 	0.068750, 0.079062, 0.108125, 0.091250, 0.085000, 0.081562, 0.087500, 0.086875, 0.072500, 0.071875, 0.067187, 0.084062, 0.069062, 0.075312, 0.069062, 0.039687, 0.008437, 0.015937, 0.036250, 0.035000, 0.026562, 0.035000, 0.034062, 0.023750, 0.027187
#*# 	0.058125, 0.065937, 0.102812, 0.095625, 0.083437, 0.090312, 0.096250, 0.088750, 0.064687, 0.068125, 0.057812, 0.070312, 0.058125, 0.070625, 0.060937, 0.038125, 0.006562, 0.020000, 0.039375, 0.048437, 0.049062, 0.043750, 0.040000, 0.046875, 0.012812
#*# 	0.094375, 0.093125, 0.119375, 0.102187, 0.100000, 0.097187, 0.107187, 0.089375, 0.078125, 0.072187, 0.077187, 0.084687, 0.067187, 0.072500, 0.065937, 0.030625, 0.004687, 0.000312, 0.034375, 0.013750, 0.015312, 0.023125, 0.034375, 0.022812, 0.011250
#*# 	0.134375, 0.142187, 0.166875, 0.152500, 0.148750, 0.151562, 0.157500, 0.145625, 0.131562, 0.137812, 0.136875, 0.140937, 0.107812, 0.114062, 0.102500, 0.074062, 0.043437, 0.045312, 0.069062, 0.070937, 0.056875, 0.070625, 0.072812, 0.063437, 0.036250
#*# 	0.185625, 0.184062, 0.207500, 0.194062, 0.187500, 0.179375, 0.189687, 0.175312, 0.155625, 0.181875, 0.175937, 0.169687, 0.137187, 0.139375, 0.119687, 0.086250, 0.054375, 0.048125, 0.071562, 0.057812, 0.064375, 0.057500, 0.064687, 0.058125, 0.050312
#*# 	0.194375, 0.193125, 0.226250, 0.212187, 0.200312, 0.208125, 0.199062, 0.184687, 0.180312, 0.174687, 0.191562, 0.185000, 0.154062, 0.153750, 0.137187, 0.095625, 0.067187, 0.071562, 0.104687, 0.096250, 0.093750, 0.096875, 0.085625, 0.080937, 0.055312
#*# 	0.195312, 0.187812, 0.225625, 0.197500, 0.203750, 0.198750, 0.211250, 0.196875, 0.168437, 0.194062, 0.187187, 0.191562, 0.147812, 0.148750, 0.143750, 0.098437, 0.061875, 0.063125, 0.083437, 0.080625, 0.078437, 0.088437, 0.077812, 0.067187, 0.063437
#*# 	0.184687, 0.195312, 0.226250, 0.209375, 0.206562, 0.210312, 0.221875, 0.215312, 0.204062, 0.202812, 0.205000, 0.211875, 0.191562, 0.193750, 0.184375, 0.154687, 0.117187, 0.120000, 0.145625, 0.160625, 0.147500, 0.158750, 0.155625, 0.150000, 0.120000
#*# 	0.187500, 0.191562, 0.234375, 0.220312, 0.211250, 0.229375, 0.233750, 0.228125, 0.213437, 0.228750, 0.227500, 0.245937, 0.209687, 0.202500, 0.212812, 0.171875, 0.137812, 0.155937, 0.159375, 0.152500, 0.157812, 0.157500, 0.166875, 0.165625, 0.146250
#*# 	0.192812, 0.200312, 0.243125, 0.228750, 0.253750, 0.252812, 0.254687, 0.255312, 0.235625, 0.246250, 0.246250, 0.258750, 0.229062, 0.241250, 0.224375, 0.194687, 0.174687, 0.174375, 0.210937, 0.179062, 0.196250, 0.185625, 0.196875, 0.189687, 0.154375
#*# 	0.211250, 0.231250, 0.265000, 0.247812, 0.243437, 0.265937, 0.277500, 0.262812, 0.250625, 0.269375, 0.269375, 0.280312, 0.253125, 0.246875, 0.240937, 0.213750, 0.176562, 0.190000, 0.200000, 0.188437, 0.195937, 0.193125, 0.176562, 0.174375, 0.142812
#*# 	0.228437, 0.242187, 0.279375, 0.269062, 0.267812, 0.277812, 0.299687, 0.282500, 0.271875, 0.294687, 0.286562, 0.290937, 0.270312, 0.266250, 0.255937, 0.222187, 0.187812, 0.193437, 0.216562, 0.202187, 0.194375, 0.187812, 0.187500, 0.167812, 0.120625
#*# 	0.219062, 0.232500, 0.268125, 0.248750, 0.254687, 0.264375, 0.275625, 0.267500, 0.252812, 0.274062, 0.252812, 0.270625, 0.245000, 0.241562, 0.228750, 0.180312, 0.140000, 0.128125, 0.142187, 0.132812, 0.125937, 0.110000, 0.101562, 0.083125, 0.048750
#*# tension = 0.2
#*# min_x = 60.0
#*# algo = lagrange
#*# y_count = 25
#*# mesh_y_pps = 0
#*# min_y = 15.0
#*# x_count = 25
#*# max_y = 219.96
#*# mesh_x_pps = 0
#*# max_x = 240.0
#*#
#*# [probe]
